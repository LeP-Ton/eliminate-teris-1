# 项目认知记录

## 2026-02-14
- 项目通过 `run.sh` 启动可执行程序，当前策略已改为“每次启动前强制重新编译”，避免启动到旧构建产物。
- `run.sh` 会优先使用 `/Applications/Xcode.app/Contents/Developer` 作为 `DEVELOPER_DIR`（若用户未手动设置）。
- 启动路径通过 `swift build --show-bin-path` 计算，避免手写架构目录导致路径偏差。
- 挑战记录标题区域已去掉模式/细分 Tag，仅保留标题文本，减少头部视觉干扰。
- 模式记录每个分桶的最大条数调整为 9，初始化时会对历史数据做排序与截断归一化。
- 挑战记录行内序号 Tag 通过 `baselineOffset` 与附件 bounds 微调，实现与分数/日期文本的中线对齐。
- 序号 Tag 当前按视觉反馈下移 3px（`attachment.bounds.y = -3`）以贴齐同一行文本。
- 测试 seed 数据采用“9条 + 0/1条混合”策略：竞分 1分钟=9、2分钟=1、3分钟=0；竞速 300分=9、600分=1、900分=0。
- 挑战记录行间距已缩减 50%，`paragraphStyle.lineSpacing` 从 `7` 调整为 `3.5`。
- 新增“玩法说明”模块，位于游戏设置与挑战记录下方，使用罗德岛风格红色主题边框，并按“基础规则/模式规则/结算规则”分类展示。
- 玩法说明会根据当前模式与规则档位动态变化（自由、竞分档位、竞速目标分），用于解释不同玩法规则。
- 玩法说明文案已改为精简版结构：仅展示“模式标题 + 模式规则 + 结算方式”，不再显示“模式规则/结算规则/当前模式”分段模块。
- 玩法说明已恢复“基础规则”，并把列表符号统一为 `•`；挑战记录在面板宽度变化时会重建排版，恢复“排名+得分/日期”两侧对齐。
- 游戏设置、时间与得分、挑战记录模块的标题与主要内容文本已统一切换为对应主题色（蓝/绿/橙），不再使用白色正文。
- 玩法说明在所有模式下都已去掉模式小标题；基础规则第二条统一为“操作方式：...”前缀并保持多语言同步。
- 自由模式下会隐藏右侧状态/记录列，并将“游戏设置”卡片扩展为占满整行宽度，与下方玩法说明卡片等宽。
- 各模块（游戏设置/时间与得分/挑战记录/玩法说明）标题前已加入主题色图标，并统一保留约 6px 的图标与标题间距。
- 玩法说明标题图标已切换为兼容性更高的 `doc.text`，并增加系统符号缺失时的回退图标，避免个别系统版本不显示。
- 模式切换时会锁定窗口 frame，避免自由/竞分/竞速切换引发窗口尺寸跳变；并在切换后强制按最终布局重算挑战记录两端对齐文本。
- Touch Bar 方块列数已从 12 扩展到 16，控制区可同时显示 16 个可交互方块。
- Touch Bar 最左格背景已贴齐左边缘（首列取消额外左 inset），修复“首个方块左侧留白”问题。
- Touch Bar 首列方块图案曾尝试左移与左对齐（用于排查留白来源），当前已回退为按钮内居中。
- Touch Bar 左侧留白根因为 ESC 专属槽位与主棋盘区域分离；现将第 0 列挂到 `escapeKeyReplacementItemIdentifier`，主棋盘显示第 1...15 列，首列保持居中且不再依赖棋盘整体左移补偿。
- ESC 槽位拆分方案在当前环境会导致“首按钮不显示”，已回退为单一 `GameTouchBarView(columnRange: 0..<16)`；ESC 继续使用 0 宽占位隐藏，优先保证首按钮可见。
- Touch Bar 当前采用“首列单独视觉补偿”方案：首列背景绘制区域向左扩展 6px，图案绘制使用首列可见区域居中，避免“左贴边”和“图案偏移”互相冲突。
- Touch Bar 最新方案：恢复 ESC 槽位拆分，第 0 列放到 `escapeKeyReplacementItemIdentifier`、第 1...15 列放主棋盘，确保最左按钮占用系统 ESC 位置且可见。
- ESC 槽位首列宽度已改为“跟随主棋盘单列宽度自适应”，通过监听主棋盘 frame 动态更新首列宽度，修复首列偏窄问题。
- ESC 槽位与主棋盘的系统分隔会放大首二列间距；曾尝试通过收敛第 1 列左内边距（`globalIndex == 1`）补偿。
- Touch Bar 曾回退为单一主棋盘槽位（`0..<16`）+ 0 宽 ESC 占位以排查首二列间距。
- 最新回调到分槽位方案：首列仍在 ESC 槽位、其余 1...15 在主棋盘槽位，但给主棋盘增加 `leadingCompensationX=8` 左移补偿以抵消跨槽位分隔，首列宽度继续按主棋盘单列宽度自适应同步。
- 已接入私有 API `NSTouchBar.presentSystemModalTouchBar` / `dismissSystemModalTouchBar`，当前策略改为“单槽位 16 列 + 系统级 modal 展示”，用于规避 ESC 预留留白与跨槽位缝隙并存问题。
- 私有 API 展示链路已升级为“双签名回退”：优先 `presentSystemModalTouchBar:systemTrayItemIdentifier:`，其次回退三参 placement 自动模式；`window.touchBar` 仅在私有调用不可用时启用，避免与系统级 modal 渲染冲突。
- 已为 Touch Bar 棋盘加入基础动画：交换/位移动画使用 tile id 插值，消除使用缩放淡出，左侧补位新方块从左向右滑入，统一采用约 0.22s 的 easing 过渡。
- 当前已恢复 ESC 隐藏占位：`escapeKeyReplacementItemIdentifier` 绑定 0 宽 `escape-placeholder`，确保不显示系统 ESC 键且保持主棋盘渲染链路不变。
- 已增强消除动画可见性：新增消除光晕/外环特效，消除缩放范围扩大（`1.22 -> 0.12`），并把过渡时长提升到 `0.28s`，使消除反馈更明显。
- 已按“答-25”回退动画时序：取消两阶段串联，恢复为单阶段过渡（`0.28s`），保留增强后的消除光晕/外环与缩放淡出效果。
- 动画时序现已按最新需求调整为三阶段：交换位移（0.16s）→ 消除反馈（0.20s）→ 左侧补位（0.24s）；通过 `lastSwapPair + transitionPhases` 串联，确保“先交换、再消除、后补位”。
